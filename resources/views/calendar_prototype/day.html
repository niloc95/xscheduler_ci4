<!DOCTYPE html>
<html lang="en" data-theme="light" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day View Prototype</title>
    <script type="importmap">
        {
            "imports": {
                "luxon": "https://cdn.jsdelivr.net/npm/luxon@3.4.4/+esm"
            }
        }
    </script>
    <link rel="stylesheet" href="/resources/css/calendar/tailwind-prototype.css">
</head>
<body class="min-h-screen bg-[#FDF7E3] px-6 py-10 text-slate-900 transition dark:bg-[#1F2937] dark:text-white/90">
    <div class="mx-auto max-w-6xl rounded-3xl border border-slate-200/80 bg-white/95 shadow-xl dark:border-slate-800 dark:bg-slate-900/90">
        <header class="border-b border-slate-200/70 px-6 py-5 dark:border-slate-800">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Single-day focus</p>
                    <p class="text-2xl font-semibold text-[#003049] dark:text-white" data-day-label>Thursday, Jan 23</p>
                </div>
                <div class="flex items-center gap-3">
                    <button class="rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800">Day</button>
                    <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800 dark:text-slate-300">+ New Appointment</span>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-[220px_1fr]">
            <aside class="border-r border-slate-200/70 bg-white/90 p-5 dark:border-slate-800 dark:bg-slate-900/70">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Providers</h2>
                    <span class="rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-500 dark:bg-slate-800 dark:text-slate-300">Filters</span>
                </div>
                <div class="mt-4 space-y-3 text-sm" data-day-provider-list></div>
                <div class="mt-6 rounded-2xl border border-dashed border-slate-300 p-4 text-xs text-slate-500 dark:border-slate-700 dark:text-slate-400">
                    Availability + color legend placeholder
                </div>
            </aside>

            <div class="overflow-hidden">
                <div class="grid grid-cols-[80px_1fr] divide-x divide-slate-200/70 dark:divide-slate-800">
                    <div class="bg-white/80 dark:bg-slate-900/70">
                        <div class="sticky top-0 z-10 border-b border-slate-200/70 bg-white/90 px-4 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:border-slate-800 dark:bg-slate-900/90">Time</div>
                        <div class="space-y-6 px-4 py-6 text-xs text-slate-500 dark:text-slate-400">
                            <div>6:00 AM</div>
                            <div>7:00 AM</div>
                            <div>8:00 AM</div>
                            <div>9:00 AM</div>
                            <div>10:00 AM</div>
                            <div>11:00 AM</div>
                            <div>12:00 PM</div>
                            <div>1:00 PM</div>
                            <div>2:00 PM</div>
                            <div>3:00 PM</div>
                            <div>4:00 PM</div>
                            <div>5:00 PM</div>
                            <div>6:00 PM</div>
                        </div>
                    </div>

                    <div class="relative overflow-auto bg-white dark:bg-slate-900">
                        <div class="grid min-w-[1100px] auto-cols-fr grid-flow-col gap-6 border-b border-slate-200/70 px-6 py-3 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:border-slate-800 dark:text-slate-400" data-day-provider-row></div>

                        <div class="relative min-h-[1000px] px-6 py-6">
                            <div class="grid min-w-[1100px] auto-cols-fr grid-flow-col gap-6" data-day-columns></div>
                            <div class="pointer-events-none absolute inset-x-0" data-day-now>
                                <div class="flex items-center gap-2">
                                    <span class="h-3 w-3 rounded-full border-2 border-white bg-rose-500 shadow shadow-rose-500/40"></span>
                                    <span class="h-0.5 flex-1 rounded bg-gradient-to-r from-rose-500 via-rose-400 to-transparent opacity-80"></span>
                                    <span class="rounded-full bg-rose-500/10 px-2 py-0.5 text-[11px] font-semibold text-rose-600 dark:text-rose-300">Now</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { calendarStore, boundActions, selectors } from '/resources/js/modules/calendar/state/index.js';
        import { samplePayload } from '/resources/js/modules/calendar/state/fixtures/samplePayload.js';
        import { getProviderTheme, formatFullDate, formatTimeLabel, minutesToPixels, getNowOffset } from '/resources/js/modules/calendar/prototype-helpers.js';

        const COLUMN_PADDING_PX = 16;

        boundActions.hydrate(samplePayload, { source: 'day-prototype' });

        const dayLabelEl = document.querySelector('[data-day-label]');
        const providerListEl = document.querySelector('[data-day-provider-list]');
        const providerRowEl = document.querySelector('[data-day-provider-row]');
        const columnsEl = document.querySelector('[data-day-columns]');
        const nowIndicatorEl = document.querySelector('[data-day-now]');

        const unsubscribe = calendarStore.subscribe(render);
        render();

        function render() {
            const state = calendarStore.getState();
            const providers = selectors.selectProviders(state);
            const columns = selectors.selectDayTimeline(state);

            dayLabelEl.textContent = formatFullDate(state.meta.rangeStart);
            providerListEl.innerHTML = providers.length ? providers.map(provider => renderProviderToggle(provider, state)).join('') : '<div class="rounded-2xl border border-dashed border-slate-200 p-3 text-xs text-slate-400 dark:border-slate-700">No providers</div>';
            bindDayProviderFilters(state);
            providerRowEl.innerHTML = columns.map(renderProviderHeading).join('');
            columnsEl.innerHTML = columns.map(column => renderProviderColumn(column, state)).join('');

            const nowOffset = getNowOffset(state.meta.nowTimestamp) + COLUMN_PADDING_PX;
            nowIndicatorEl.style.top = `${nowOffset}px`;
        }

        function renderProviderToggle(provider, state) {
            const theme = getProviderTheme(provider);
            const activeSet = state.filters.providerIds ?? new Set();
            const restrictMode = activeSet.size > 0;
            const isChecked = !restrictMode || activeSet.has(provider.id);
            return `
                <label class="flex items-center justify-between rounded-2xl border border-transparent bg-slate-100 px-3 py-2 font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                    <span class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full ${theme.dot}"></span>${provider.displayName}</span>
                    <input type="checkbox" data-provider-checkbox value="${provider.id}" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-slate-300 text-slate-600">
                </label>
            `;
        }

        function bindDayProviderFilters() {
            if (!providerListEl) return;
            providerListEl.querySelectorAll('[data-provider-checkbox]').forEach(input => {
                input.addEventListener('change', () => boundActions.toggleProvider(input.value));
            });
        }

        function renderProviderHeading(column) {
            const provider = column.providerName;
            const theme = getProviderTheme({ colorToken: column.colorToken });
            return `<div class="flex items-center gap-2"><span class="h-2.5 w-2.5 rounded-full ${theme.dot}"></span>${provider}</div>`;
        }

        function renderProviderColumn(column, state) {
            const theme = getProviderTheme({ colorToken: column.colorToken });
            const blocks = column.blocks.map(block => renderDayBlock(block, state, theme));
            return `
                <div class="relative min-h-[920px] rounded-3xl border border-dashed border-slate-200 bg-white/80 px-3 pb-6 pt-4 dark:border-slate-700 dark:bg-slate-900/70">
                    ${blocks.join('') || '<div class="text-center text-xs text-slate-400">No appointments</div>'}
                </div>
            `;
        }

        function renderDayBlock(block, state, theme) {
            const top = minutesToPixels(block.startOffsetMinutes);
            const height = minutesToPixels(block.heightMinutes);
            const provider = state.providers[block.providerId];
            const durationLabel = `${Math.round(block.heightMinutes)}m`;
            const patient = block.summary;
            const visit = block.subtext || provider?.displayName || '';
            const widthPercent = 100 / (block.laneCount || 1);
            const leftPercent = widthPercent * (block.laneIndex || 0);
            return `
                <article class="absolute rounded-3xl border ${theme.chipBorder} ${theme.chipBg} p-4 text-xs shadow-sm dark:border-opacity-40" style="top:${top}px; height:${height}px; left:calc(${leftPercent}% + 2px); width:calc(${widthPercent}% - 4px);">
                    <div class="flex items-center justify-between text-[11px] font-semibold ${theme.chipText}">
                        <span>${formatTimeLabel(block.startIso)}</span>
                        <span class="rounded-full bg-white/70 px-2 py-0.5 text-[10px]">${durationLabel}</span>
                    </div>
                    <div class="mt-1 text-sm font-semibold text-slate-900 dark:text-white">${patient}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-300">${visit}</div>
                </article>
            `;
        }

        window.addEventListener('beforeunload', unsubscribe);
    </script>
</body>
</html>
